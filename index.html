<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متابعة الحضور - كشف الحضور</title>

    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
        body{background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);min-height:100vh;padding:20px;display:flex;flex-direction:column;align-items:center}
        .container{max-width:900px;width:100%;background:#fff;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
        h1{text-align:center;color:#2c3e50;margin-bottom:10px}
        .subtitle{text-align:center;color:#7f8c8d;margin-bottom:20px}
        
        /* تحسينات الجدول للهواتف */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        table{width:100%;border-collapse:collapse;font-size:14px;min-width:600px}
        th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break: break-word;}
        th{background:#2c3e50;color:#fff}
        tr:nth-child(even){background:#f9f9f9}
        
        /* تحسينات للأزرار */
        .button-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button{min-width:150px;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:15px}
        .fetch-btn{background:#2ecc71;color:#fff}.auto-btn{background:#9b59b6;color:#fff}
        .fetch-btn:hover{background:#27ae60}.auto-btn:hover{background:#8e44ad}
        
        /* تحسينات الحالة */
        .status{margin-top:15px;padding:12px;border-radius:8px;text-align:center;font-weight:bold;display:none}
        .success{background:#d4edda;color:#155724}.error{background:#f8d7da;color:#721c24}
        
        /* تحسينات التحميل */
        .loading{display:none;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s infinite;display:inline-block;margin-right:5px}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* تحسينات للشاشات الصغيرة */
        @media(max-width:768px){
            .container{padding:15px}
            h1{font-size:1.5rem}
            .subtitle{font-size:0.9rem}
            table{font-size:12px}
            th,td{padding:6px}
            button{width:100%;font-size:14px;padding:12px}
        }
        
        @media(max-width:480px){
            body{padding:10px}
            .container{padding:10px}
            h1{font-size:1.3rem}
            table{font-size:11px}
            th,td{padding:4px}
        }
    </style>
</head>
<body>

<div class="container">
    <h1>كشف الحضور</h1>
    <p class="subtitle">عرض بيانات المشاركين مباشرة من Google Sheets</p>

    <div class="button-container">
        <button id="fetchData" class="fetch-btn"><span id="fetchLoading" class="loading"></span>جلب البيانات</button>
        <button id="autoUpdate" class="auto-btn"><span id="autoUpdateLoading" class="loading"></span>التحديث التلقائي</button>
    </div>

    <div id="statusMessage" class="status"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>الوقت</th>
                    <th>الاسم</th>
                    <th>الجهة / المؤسسة</th>
                    <th>المسمى الوظيفي</th>
                    <th>رقم الهاتف</th>
                    <th>البريد الإلكتروني</th>
                </tr>
            </thead>
            <tbody id="attendanceBody"></tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const attendanceBody = document.getElementById('attendanceBody');
    const fetchDataBtn = document.getElementById('fetchData');
    const autoBtn = document.getElementById('autoUpdate');
    const statusMessage = document.getElementById('statusMessage');
    const fetchLoading = document.getElementById('fetchLoading');
    const autoLoading = document.getElementById('autoUpdateLoading');

    let autoInterval = null;
    let autoMode = false;

    // ✅ رابط CSV لورقة كشف الحضور
    const CSV_URL = "https://docs.google.com/spreadsheets/d/1f1HNLFlReMt5evkSCo06uGBh9l3wPQusSMPGyHEyBoo/gviz/tq?tqx=out:csv&sheet=كشف%20الحضور";

    async function fetchAttendance(showMsg = true) {
        try {
            if (autoMode) autoLoading.style.display = "inline-block"; 
            else { fetchLoading.style.display = "inline-block"; fetchDataBtn.disabled = true; }

            const res = await fetch(CSV_URL);
            const csv = await res.text();
            const rows = csv.split("\n").map(r => r.split(","));
          rows.shift();

            attendanceBody.innerHTML = "";

            rows.forEach(r => {
                if (r.length >= 6) {
                    let tr = document.createElement("tr");
                    for (let i = 0; i < 6; i++) {
                        let td = document.createElement("td");
                        td.textContent = r[i] ?? '';
                        tr.appendChild(td);
                    }
                    attendanceBody.appendChild(tr);
                }
            });

            if (showMsg) showStatus("✅ تم تحديث البيانات", "success");

        } catch (e) {
            showStatus("❌ خطأ في جلب البيانات", "error");
        } finally {
            fetchLoading.style.display = "none";
            autoLoading.style.display = "none";
            fetchDataBtn.disabled = false;
        }
    }

    function autoToggle() {
        if (autoInterval) {
            clearInterval(autoInterval);
            autoInterval = null;
            autoMode = false;
            autoBtn.textContent = "التحديث التلقائي";
            showStatus("❌ تم إيقاف التحديث التلقائي", "error");
        } else {
            autoMode = true;
            autoInterval = setInterval(() => fetchAttendance(false), 5000);
            autoBtn.textContent = "إيقاف التحديث";
            showStatus("✅ التحديث كل 5 ثواني يعمل", "success");
            fetchAttendance(false);
        }
    }

    function showStatus(msg, type) {
        statusMessage.className = "status " + type;
        statusMessage.textContent = msg;
        statusMessage.style.display = "block";
        setTimeout(() => statusMessage.style.display = "none", 4000);
    }

    fetchDataBtn.onclick = () => fetchAttendance(true);
    autoBtn.onclick = autoToggle;

    fetchAttendance(false);
});
</script>

</body>
</html>
